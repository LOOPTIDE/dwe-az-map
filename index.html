<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Arizona ZIP Territories — GitHub Pages Build</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<style>
  html, body, #map { height: 100%; margin: 0; padding: 0; }
  .legend { background: white; padding: 10px; line-height: 1.4; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.2); font-size: 12px; max-width: 420px; overflow-y: auto; max-height: 60vh; }
  .legend .row { display: flex; align-items: center; margin-bottom: 6px; }
  .legend .swatch { width: 14px; height: 14px; border-radius: 3px; margin-right: 8px; border: 1px solid #00000022; }
  .region-label { background: rgba(255,255,255,0.85); padding: 2px 6px; border-radius: 6px; border: 1px solid #00000022; font-weight: 600; white-space: nowrap; }
  .topbar { position: absolute; z-index: 9999; top: 10px; left: 10px; background: rgba(255,255,255,0.95); padding: 8px 10px; border-radius: 8px; border: 1px solid #00000022; font-size: 12px; }
  .status { margin-top: 4px; color: #555; }
</style>
</head>
<body>
<div id="map"></div>

<div class="topbar">
  <div><strong>ZIP boundaries source:</strong> Local file (same repo)</div>
  <div class="status" id="status">Loading…</div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>

<script>
// --- CONFIG ----
const ZIP_TO_TERRITORY = {"85260":"AZ-02: Central+Airport+Price","85281":"AZ-03: Southeast+Pinal","85040":"AZ-03: Southeast+Pinal","85307":"AZ-01: West Valley","85043":"AZ-02: Central+Airport+Price","85303":"AZ-01: West Valley","85225":"AZ-03: Southeast+Pinal","85226":"AZ-03: Southeast+Pinal","85017":"AZ-02: Central+Airport+Price","85353":"AZ-01: West Valley","85009":"AZ-02: Central+Airport+Price","85019":"AZ-02: Central+Airport+Price","85008":"AZ-02: Central+Airport+Price","85021":"AZ-02: Central+Airport+Price","85041":"AZ-03: Southeast+Pinal","85233":"AZ-03: Southeast+Pinal","85379":"AZ-01: West Valley","85202":"AZ-03: Southeast+Pinal","85212":"AZ-03: Southeast+Pinal","85286":"AZ-03: Southeast+Pinal","85258":"AZ-02: Central+Airport+Price","85003":"AZ-02: Central+Airport+Price","85035":"AZ-01: West Valley","85027":"AZ-02: Central+Airport+Price","85034":"AZ-03: Southeast+Pinal","85044":"AZ-03: Southeast+Pinal","85284":"AZ-03: Southeast+Pinal","85345":"AZ-01: West Valley","85297":"AZ-03: Southeast+Pinal","85395":"AZ-01: West Valley","85392":"AZ-01: West Valley","85338":"AZ-01: West Valley","85301":"AZ-02: Central+Airport+Price","85210":"AZ-03: Southeast+Pinal","85282":"AZ-03: Southeast+Pinal","85288":"AZ-02: Central+Airport+Price","85031":"AZ-02: Central+Airport+Price","85326":"AZ-01: West Valley","85004":"AZ-02: Central+Airport+Price","85193":"AZ-03: Southeast+Pinal","85014":"AZ-02: Central+Airport+Price","85335":"AZ-01: West Valley","85381":"AZ-01: West Valley","85340":"AZ-01: West Valley","85140":"AZ-03: Southeast+Pinal","85143":"AZ-03: Southeast+Pinal","85363":"AZ-01: West Valley","85224":"AZ-03: Southeast+Pinal","85029":"AZ-02: Central+Airport+Price","85339":"AZ-03: Southeast+Pinal","85205":"AZ-03: Southeast+Pinal","85122":"AZ-03: Southeast+Pinal","85283":"AZ-03: Southeast+Pinal","85388":"AZ-01: West Valley","85355":"AZ-01: West Valley","85256":"AZ-02: Central+Airport+Price","85007":"AZ-02: Central+Airport+Price","85215":"AZ-03: Southeast+Pinal","85323":"AZ-01: West Valley","85138":"AZ-03: Southeast+Pinal","85201":"AZ-02: Central+Airport+Price","85120":"AZ-03: Southeast+Pinal","85131":"AZ-03: Southeast+Pinal","85257":"AZ-02: Central+Airport+Price","85248":"AZ-03: Southeast+Pinal","85255":"AZ-02: Central+Airport+Price","85083":"AZ-02: Central+Airport+Price","85204":"AZ-03: Southeast+Pinal","85207":"AZ-03: Southeast+Pinal","85142":"AZ-03: Southeast+Pinal","85128":"AZ-03: Southeast+Pinal","85024":"AZ-02: Central+Airport+Price","85139":"AZ-03: Southeast+Pinal","85085":"AZ-02: Central+Airport+Price","85354":"AZ-01: West Valley","85322":"AZ-01: West Valley","85296":"AZ-03: Southeast+Pinal","85308":"AZ-02: Central+Airport+Price","85209":"AZ-03: Southeast+Pinal","85033":"AZ-01: West Valley","85042":"AZ-03: Southeast+Pinal","85050":"AZ-02: Central+Airport+Price","85194":"AZ-03: Southeast+Pinal","85206":"AZ-03: Southeast+Pinal","85274":"AZ-03: Southeast+Pinal","85280":"AZ-03: Southeast+Pinal","85295":"AZ-03: Southeast+Pinal","85305":"AZ-01: West Valley","85309":"AZ-01: West Valley","85382":"AZ-01: West Valley","85012":"AZ-02: Central+Airport+Price","85016":"AZ-02: Central+Airport+Price","85018":"AZ-02: Central+Airport+Price","85028":"AZ-02: Central+Airport+Price","85053":"AZ-02: Central+Airport+Price","85054":"AZ-02: Central+Airport+Price","85213":"AZ-02: Central+Airport+Price","85250":"AZ-02: Central+Airport+Price","85251":"AZ-02: Central+Airport+Price","85253":"AZ-02: Central+Airport+Price","85254":"AZ-02: Central+Airport+Price","85374":"AZ-01: West Valley","85006":"AZ-02: Central+Airport+Price","85387":"AZ-01: West Valley","85234":"AZ-03: Southeast+Pinal","85249":"AZ-03: Southeast+Pinal","85121":"AZ-03: Southeast+Pinal","85203":"AZ-02: Central+Airport+Price","85037":"AZ-01: West Valley","85013":"AZ-02: Central+Airport+Price","85015":"AZ-02: Central+Airport+Price","85020":"AZ-02: Central+Airport+Price","85022":"AZ-02: Central+Airport+Price","85023":"AZ-02: Central+Airport+Price","85032":"AZ-02: Central+Airport+Price","85045":"AZ-03: Southeast+Pinal","85048":"AZ-03: Southeast+Pinal","85051":"AZ-02: Central+Airport+Price","85086":"AZ-02: Central+Airport+Price","85118":"AZ-03: Southeast+Pinal","85119":"AZ-03: Southeast+Pinal","85132":"AZ-03: Southeast+Pinal","85147":"AZ-03: Southeast+Pinal","85208":"AZ-03: Southeast+Pinal","85236":"AZ-03: Southeast+Pinal","85259":"AZ-02: Central+Airport+Price","85262":"AZ-02: Central+Airport+Price","85266":"AZ-02: Central+Airport+Price","85268":"AZ-02: Central+Airport+Price","85269":"AZ-02: Central+Airport+Price","85285":"AZ-03: Southeast+Pinal","85298":"AZ-03: Southeast+Pinal","85302":"AZ-02: Central+Airport+Price","85304":"AZ-02: Central+Airport+Price","85306":"AZ-02: Central+Airport+Price","85310":"AZ-02: Central+Airport+Price","85318":"AZ-02: Central+Airport+Price","85331":"AZ-02: Central+Airport+Price","85351":"AZ-01: West Valley","85373":"AZ-01: West Valley","85375":"AZ-01: West Valley","85378":"AZ-02: Central+Airport+Price","85383":"AZ-02: Central+Airport+Price","85396":"AZ-01: West Valley","85087":"AZ-02: Central+Airport+Price","85144":"AZ-02: Central+Airport+Price","85263":"AZ-02: Central+Airport+Price","85264":"AZ-02: Central+Airport+Price","85377":"AZ-02: Central+Airport+Price","85631":"AZ-03: Southeast+Pinal","85361":"AZ-01: West Valley","85172":"AZ-03: Southeast+Pinal"};
const TERRITORY_TO_COLOR = {"AZ-01: West Valley":"#E69F00","AZ-02: Central+Airport+Price":"#56B4E9","AZ-03: Southeast+Pinal":"#009E73"};

// Use a RELATIVE path to avoid cross-origin/CSP issues. Place this file in the same repo.
const LOCAL_GEOJSON_PATH = "./az_arizona_zip_codes_geo.min.json";

const statusEl = document.getElementById('status');
const map = L.map('map', { preferCanvas: true }).setView([33.45, -112.07], 9);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  maxZoom: 18,
  attribution: '&copy; OpenStreetMap contributors'
}).addTo(map);

const zipLayer = L.geoJSON(null, {
  style: function(feature) {
    const zip = feature.properties.ZCTA5CE10 || feature.properties.ZCTA5CE || feature.properties.ZCTA5 || feature.properties.GEOID10;
    const terr = ZIP_TO_TERRITORY[zip];
    const color = terr ? TERRITORY_TO_COLOR[terr] : '#cccccc';
    return { color: '#333333', weight: 0.4, fillColor: color, fillOpacity: terr ? 0.45 : 0.0 };
  },
  onEachFeature: function(feature, layer) {
    const zip = feature.properties.ZCTA5CE10 || feature.properties.ZCTA5CE || feature.properties.ZCTA5 || feature.properties.GEOID10;
    const terr = ZIP_TO_TERRITORY[zip];
    if (terr) layer.bindPopup('<strong>'+zip+'</strong><br/>'+terr);
  }
});

const outlineLayer = L.geoJSON(null, {
  style: function(feature) {
    const t = feature.properties && feature.properties.territory;
    const color = t && TERRITORY_TO_COLOR[t] ? TERRITORY_TO_COLOR[t] : '#000';
    return { color: color, weight: 3, fill: false, opacity: 0.95 };
  }
}).addTo(map);

const labelLayer = L.layerGroup().addTo(map);

function addLegend() {
  const legend = L.control({position: 'bottomright'});
  legend.onAdd = function (map) {
    const div = L.DomUtil.create('div', 'legend');
    div.innerHTML = '<div style="font-weight:600;margin-bottom:6px;">Arizona ZIP Territories — v3</div>';
    const entries = Object.entries(TERRITORY_TO_COLOR);
    entries.forEach(function(ent){
      var r=ent[0], c=ent[1];
      const row = document.createElement('div');
      row.className = 'row';
      row.innerHTML = '<span class="swatch" style="background:'+c+'"></span> <span>'+r+'</span>';
      div.appendChild(row);
    });
    return div;
  };
  legend.addTo(map);

  L.control.layers(null, {
    'ZIP Polygons': zipLayer,
    'Territory Outlines': outlineLayer,
    'Territory Labels': labelLayer
  }, { collapsed: true }).addTo(map);
}

function renderFromGeo(geo) {
  const wanted = new Set(Object.keys(ZIP_TO_TERRITORY));
  const filtered = { type:'FeatureCollection', features: [] };
  for (const f of geo.features) {
    const z = (f.properties.ZCTA5CE10 || f.properties.ZCTA5CE || f.properties.ZCTA5 || f.properties.GEOID10 || '').toString();
    if (wanted.has(z)) filtered.features.push(f);
  }
  zipLayer.addData(filtered).addTo(map);
  try { map.fitBounds(zipLayer.getBounds(), { padding: [20,20] }); } catch(e) {}

  const byTerr = new Map();
  for (const f of filtered.features) {
    const z = (f.properties.ZCTA5CE10 || f.properties.ZCTA5CE || f.properties.ZCTA5 || f.properties.GEOID10 || '').toString();
    const terr = ZIP_TO_TERRITORY[z];
    if (!byTerr.has(terr)) byTerr.set(terr, []);
    byTerr.get(terr).push(f);
  }

  byTerr.forEach(function(features, terr){
    let unioned = null;
    try {
      unioned = features.reduce(function(a, f, i){
        if (i === 0) return f;
        try { return turf.union(a, f) || a; } catch(e){ return a; }
      }, null);
    } catch(e){ unioned = null; }

    if (!unioned) unioned = turf.combine({ type:'FeatureCollection', features: features });

    if (Array.isArray(unioned.features)) {
      for (const uf of unioned.features) {
        uf.properties = Object.assign({}, uf.properties, { territory: terr });
        outlineLayer.addData(uf);
      }
    } else if (unioned) {
      unioned.properties = Object.assign({}, unioned.properties || {}, { territory: terr });
      outlineLayer.addData(unioned);
    }

    try {
      const c = turf.center(unioned);
      if (c && c.geometry && c.geometry.coordinates) {
        const lg = c.geometry.coordinates[0], lt = c.geometry.coordinates[1];
        const di = L.divIcon({ className: 'region-label', html: terr, iconSize: null });
        L.marker([lt, lg], { icon: di }).addTo(labelLayer);
      }
    } catch(e){}
  });

  addLegend();
}

async function loadLocal() {
  statusEl.textContent = 'Loading local GeoJSON…';
  try {
    const resp = await fetch(LOCAL_GEOJSON_PATH, { cache: 'force-cache' });
    if (!resp.ok) throw new Error('HTTP ' + resp.status);
    const geo = await resp.json();
    statusEl.textContent = 'Loaded local AZ ZIP boundaries';
    renderFromGeo(geo);
  } catch (e) {
    console.error(e);
    statusEl.textContent = 'Could not load local GeoJSON. Ensure az_arizona_zip_codes_geo.min.json is in the same folder.';
  }
}

loadLocal();
</script>
</body>
</html>